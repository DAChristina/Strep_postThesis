---
title: "The Visualisation of 12F Serotype"
author: "Dewi Anastasia Christina"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)

if(!require(pacman)) install.packages("pacman")
pacman::p_load(reactable, tidyverse, plotly)
```

## 1. Introduction

### 1.1. Data

1.  Epidata (2001-2022): Serotype-level data Version 1 (daily data 2017-2022) combined with Version 3 (epidemiological year separated into six age bands, grouped per week 2001-2017) supplied by UKHSA.
2.  Weekly invasive GPSC55 cases from WGS line-list

### 1.2. Some context

Previously, Lilith use epidemiological annual data of invasive 12F cases separated into two age bands (2010/11-2016/17). We got new serotype-level epidemiological data on January 2025.

```{r}
# load data
dat_c <- read.csv("../raw_data/12F_Jan_2025_combined_cleaned.csv") %>% 
  dplyr::filter(ageGroup3 != "Unknown")
gen <- read.csv("../raw_data/genomic_data_cleaned.csv") %>% 
  dplyr::filter(!is.na(strain))

col_map <- c(
  # Data version
  "12F ver1 (2016-2022)" = "indianred4",
  "12F ver2 (2009.5-2022.5)" = "seagreen4",
  "12F ver3 weekly (2001-2017)" = "orange2",
  "serotype 1" = "steelblue",
  "7F" = "purple3",
  "12F ver1 & 3 (2001-2022)" = "indianred4",
  
  # Vaccination
  "Pre-PCV7" = "lightblue",
  "PCV7" = "gray70",
  "PCV13" = "gray20",
  
  # 2 age bands
  "children" = "darkred",
  "adults" = "darkblue",
  
  # 3 age bands
  "<2" = "indianred4",
  "2-64" = "seagreen4",
  "65+" = "purple3",
  
  # 5 age bands 
  "<5" = "indianred4",
  "5-18" = "orange",
  "19-30" = "seagreen4",
  "31-64" = "steelblue",
  #"65+" = "purple3",
  
  # 6 age bands 
  #"<2" = "indianred4", 
  "2-4" = "indianred2", 
  "5-14" = "orange",
  "15-44" = "seagreen4",
  "45-64" = "steelblue",
  #"65+" = "purple3",
  
  # 7 age bands
  #"<2" = "indianred4", 
  #"2-4" = "indianred2", 
  #"5-14" = "orange",
  "15-30" = "seagreen1", # Edit the Age-band into 15-30 & 31-44
  "31-44" = "seagreen4", # Edit the Age-band into 15-30 & 31-44
  #"45-64" = "steelblue",
  #"65+" = "purple3",
  "Unknown" = "black",
  
  # Regions (From north to south)
  "North West" = "indianred4",
  "North East" = "steelblue",
  "Yorkshire and The Humber" = "seagreen4",
  "East Midlands" = "purple3",
  "West Midlands" = "orange",
  "East of England" = "indianred2",
  "London" = "seagreen1",
  "South East" = "deepskyblue",
  "South West" = "gold1",
  # Cases vs sequenced
  "Serotype 1 Case" = "gray75",
  "Sequenced" = "deepskyblue3",
  "Meningitis" = "green",
  "30 Day Death" = "maroon"
)

vaccine_UK <- data.frame(
  year = c(2011),
  vaccine = c("PCV13")
)
```

## 2. Visualisations

### 2.1. Non-heterogeneity: annually, monthly and weekly

```{r}
# data preparation
# non-heterogeneity
allAges_annually <- dplyr::full_join(
  dat_c %>% 
    dplyr::group_by(year) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::group_by(year) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = "year"
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(across(everything(), ~replace_na(.x, 0)))

allAges_monthly <- dplyr::full_join(
  dat_c %>% 
    dplyr::group_by(yearMonth) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::group_by(yearMonth) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = "yearMonth"
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(yearMonth = as.Date(yearMonth),
                across(everything(), ~replace_na(.x, 0)))

allAges_weekly <- dplyr::full_join(
  dat_c %>% 
    dplyr::mutate(week_date = as.Date(week_date),
                  iso_week = paste0(year(week_date), "-W", sprintf("%02d", week(week_date)), "-1"),
                  yearWeek =ISOweek::ISOweek2date(iso_week)
                  ) %>% 
    dplyr::group_by(yearWeek) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::mutate(week_date = as.Date(week_date),
                  iso_week = paste0(year(week_date), "-W", sprintf("%02d", week(week_date)), "-1"),
                  yearWeek =ISOweek::ISOweek2date(iso_week)
                  ) %>% 
    dplyr::group_by(yearWeek) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = "yearWeek"
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(# yearWeek = as.Date(yearWeek),
                across(everything(), ~replace_na(.x, 0)))


# plot preparation
p_allAges_year <- ggplot(allAges_annually, aes(x = year, y = count, color = type)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = c(0.1, 0.85),
        legend.title = element_blank(),
        legend.key.size = unit(0.8, "lines"),
        legend.text = element_text(size = 10),
        legend.background = element_rect(fill = "transparent", color = "transparent"))

p_allAges_month <- ggplot(allAges_monthly, aes(x = yearMonth, y = count, color = type)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = c(0.1, 0.85),
        legend.title = element_blank(),
        legend.key.size = unit(0.8, "lines"),
        legend.text = element_text(size = 10),
        legend.background = element_rect(fill = "transparent", color = "transparent"))

p_allAges_week <- ggplot(allAges_weekly, aes(x = yearWeek, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date)), max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = c(0.1, 0.85),
        legend.title = element_blank(),
        legend.key.size = unit(0.8, "lines"),
        legend.text = element_text(size = 10),
        legend.background = element_rect(fill = "transparent", color = "transparent"))


```

I think we can test weekly data for non-heterogeneity model, but we have to omit the data before min(as.Date(gen\$collection_date))+541

```{r}
# load picts

p_allAges <- cowplot::plot_grid(p_allAges_year, p_allAges_month, p_allAges_week,
                                ncol = 1,
                                labels = c("A", "B", "C"))


p_allAges
```

### 2.1. 3 demographic groups: annually, monthly and weekly

```{r}
# data preparation
# ageGroup3
ageGroup3_annually <- dplyr::full_join(
  dat_c %>% 
    dplyr::group_by(year, ageGroup3) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::group_by(year, ageGroup3) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = c("year", "ageGroup3")
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(across(everything(), ~replace_na(.x, 0)))

ageGroup3_monthly <- dplyr::full_join(
  dat_c %>% 
    dplyr::group_by(yearMonth, ageGroup3) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::group_by(yearMonth, ageGroup3) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = c("yearMonth", "ageGroup3")
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(yearMonth = as.Date(yearMonth),
                across(everything(), ~replace_na(.x, 0)))

ageGroup3_weekly <- dplyr::full_join(
  dat_c %>% 
    dplyr::mutate(week_date = as.Date(week_date),
                  iso_week = paste0(year(week_date), "-W", sprintf("%02d", week(week_date)), "-1"),
                  yearWeek =ISOweek::ISOweek2date(iso_week)
                  ) %>% 
    dplyr::group_by(yearWeek, ageGroup3) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::mutate(week_date = as.Date(week_date),
                  iso_week = paste0(year(week_date), "-W", sprintf("%02d", week(week_date)), "-1"),
                  yearWeek =ISOweek::ISOweek2date(iso_week)
                  ) %>% 
    dplyr::group_by(yearWeek, ageGroup3) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = c("yearWeek", "ageGroup3")
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(# yearWeek = as.Date(yearWeek),
                across(everything(), ~replace_na(.x, 0)))


# plot preparation
p_ageGroup3_year <- ggplot(ageGroup3_annually, aes(x = year, y = count, color = type)) +
  geom_line() +
  scale_x_continuous(limits = c(min(lubridate::year(as.Date(gen$collection_date)))+1.5, max(lubridate::year(as.Date(dat_c$week_date)))),
                     breaks = ~ axisTicks(., log = FALSE)) +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup3,
             nrow =1,
             scales = "free_y")

p_ageGroup3_month <- ggplot(ageGroup3_monthly, aes(x = yearMonth, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date))+541, max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup3,
             nrow =1,
             scales = "free_y")

p_ageGroup3_week <- ggplot(ageGroup3_weekly, aes(x = yearWeek, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date))+541, max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup3,
             nrow =1,
             scales = "free_y")


```

I think we can test weekly data for 3 age groups, but we have to omit the data before min(as.Date(gen\$collection_date))+541

```{r}
# load picts

p_ageGroup3 <- cowplot::plot_grid(p_ageGroup3_year, p_ageGroup3_month, p_ageGroup3_week,
                                ncol = 1,
                                labels = c("A", "B", "C"))


p_ageGroup3
```


### 2.1. 6 demographic groups: annually, monthly and weekly
```{r}
# data preparation
# ageGroup6
ageGroup6_annually <- dplyr::full_join(
  dat_c %>% 
    dplyr::group_by(year, ageGroup6) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::group_by(year, ageGroup6) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = c("year", "ageGroup6")
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(across(everything(), ~replace_na(.x, 0)),
                ageGroup6 = factor(ageGroup6,
                                   levels = c("<2", "2-4", "5-14",
                                              "15-44", "45-64", "65+")))

ageGroup6_monthly <- dplyr::full_join(
  dat_c %>% 
    dplyr::group_by(yearMonth, ageGroup6) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::group_by(yearMonth, ageGroup6) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = c("yearMonth", "ageGroup6")
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(yearMonth = as.Date(yearMonth),
                across(everything(), ~replace_na(.x, 0)),
                ageGroup6 = factor(ageGroup6,
                                   levels = c("<2", "2-4", "5-14",
                                              "15-44", "45-64", "65+")))

ageGroup6_weekly <- dplyr::full_join(
  dat_c %>% 
    dplyr::mutate(week_date = as.Date(week_date),
                  iso_week = paste0(year(week_date), "-W", sprintf("%02d", week(week_date)), "-1"),
                  yearWeek =ISOweek::ISOweek2date(iso_week)
                  ) %>% 
    dplyr::group_by(yearWeek, ageGroup6) %>% 
    dplyr::summarise(count_serotype = sum(counts)) %>% 
    dplyr::ungroup()
  ,
  gen %>% 
    dplyr::mutate(week_date = as.Date(week_date),
                  iso_week = paste0(year(week_date), "-W", sprintf("%02d", week(week_date)), "-1"),
                  yearWeek =ISOweek::ISOweek2date(iso_week)
                  ) %>% 
    dplyr::group_by(yearWeek, ageGroup6) %>% 
    dplyr::summarise(count_WGS = n()) %>% 
    dplyr::ungroup()
  ,
  by = c("yearWeek", "ageGroup6")
) %>% 
  tidyr::pivot_longer(
    cols = starts_with("count_"),
    names_to = "type",
    values_to = "count"
  ) %>% 
  dplyr::mutate(# yearWeek = as.Date(yearWeek),
                across(everything(), ~replace_na(.x, 0)),
                ageGroup6 = factor(ageGroup6,
                                   levels = c("<2", "2-4", "5-14",
                                              "15-44", "45-64", "65+")))


# plot preparation
p_ageGroup6_year <- ggplot(ageGroup6_annually, aes(x = year, y = count, color = type)) +
  geom_line() +
  scale_x_continuous(limits = c(min(lubridate::year(as.Date(gen$collection_date)))+1.5, max(lubridate::year(as.Date(dat_c$week_date)))),
                     breaks = ~ axisTicks(., log = FALSE)) +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup6,
             nrow =1,
             scales = "free_y")

p_ageGroup6_month <- ggplot(ageGroup6_monthly, aes(x = yearMonth, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date))+541, max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup6,
             nrow =1,
             scales = "free_y")

p_ageGroup6_week <- ggplot(ageGroup6_weekly, aes(x = yearWeek, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date))+541, max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup6,
             nrow =1,
             scales = "free_y")


```

I think we can test weekly data for 3 age groups, but we have to omit the data before min(as.Date(gen\$collection_date))+541

```{r}
# load picts

p_ageGroup6 <- cowplot::plot_grid(p_ageGroup6_year, p_ageGroup6_month, p_ageGroup6_week,
                                ncol = 1,
                                labels = c("A", "B", "C"))


p_ageGroup6
```


Test yearMonth and yearWeek


```{r}
p_ageGroup6_month_2 <- ggplot(ageGroup6_monthly, aes(x = yearMonth, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date))+541, max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup6,
             nrow =6,
             scales = "free_y")

p_ageGroup6_week_2 <- ggplot(ageGroup6_weekly, aes(x = yearWeek, y = count, color = type)) +
  geom_line() +
  scale_x_date(limits = c(min(as.Date(gen$collection_date))+541, max(as.Date(dat_c$week_date))),
               date_breaks = "1 year",
               date_labels = "%Y") +
  theme_bw() +
  theme(legend.position = "none") +
  # theme(legend.position = c(0.1, 0.85),
  #       legend.title = element_blank(),
  #       legend.key.size = unit(0.8, "lines"),
  #       legend.text = element_text(size = 10),
  #       legend.background = element_rect(fill = "transparent", color = "transparent")) +
  facet_wrap(~ ageGroup6,
             nrow =6,
             scales = "free_y")


```



```{r}
p_ageGroup6_month_2

```

hmm, weird...

week is too chaotic in some age groups.
```{r}
p_ageGroup6_week_2

```



fin.